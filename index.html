<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<title>Trivium Grain 库示例</title>
	<script src="TriviumGrain.js"></script>
	<style>
		body {
			font-family: "Microsoft YaHei", sans-serif;
			max-width: 1000px;
			margin: 0 auto;
			padding: 5px;
			line-height: 1.2
		}

		.container {
			background: #f5f5f5;
			padding: 20px;
			border-radius: 1px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, .1)
		}

		.form-group {
			margin-bottom: 10px
		}

		label {
			display: block;
			margin-bottom: 8px;
			font-weight: bold;
			color: #333
		}

		textarea,
		select,
		input {
			width: 100%;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 4px;
			box-sizing: border-box;
			font-family: inherit
		}

		textarea {
			min-height: 100px;
			resize: vertical
		}

		.btn-group {
			display: flex;
			gap: 20px;
			margin-bottom: 5px
		}

		button {
			padding: 8px 20px;
			background: #4CAF50;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px
		}

		button:hover {
			background: #45a049
		}

		.key-iv-display {
			font-family: monospace;
			word-break: break-all;
			background: #fff;
			padding: 10px;
			border-radius: 5px;
			margin-top: 0px
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>Trivium Grain 库示例</h1>
		<p>使用 Trivium 或 Grain v1 算法进行加密/解密，开源地址：<a href="https://github.com/fzxx/Trivium-Grain"
				target="_blank">https://github.com/fzxx/Trivium-Grain</a></p>

		<div class="form-group">
			<label>选择加密算法：
				<select id="algorithm">
					<option value="trivium">Trivium (密钥 80位，IV 80位)</option>
					<option value="grain">Grain v1 (密钥 80位，IV 64位)</option>
				</select>
			</label>
		</div>

		<div class="form-group">
			<label>密钥 (Hex)：</label>
			<div style="display:flex;align-items:center;gap:10px">
				<input id="keyDisplay" class="key-iv-display" style="width:420px" placeholder="请生成或输入十六进制密钥">
				<button id="generateKey">生成随机密钥</button>
			</div>
		</div>

		<div class="form-group">
			<label>初始向量 (IV)：</label>
			<div style="display:flex;align-items:center;gap:10px">
				<input id="ivDisplay" class="key-iv-display" style="width:420px" placeholder="请生成或输入IV">
				<button id="generateIv">生成随机IV</button>
			</div>
		</div>

		<div class="form-group">
			<label>明文：<br><textarea id="plaintext" placeholder="请输入要加密的文本"></textarea></label>
		</div>

		<div class="form-group">
			<label>密文 (Hex)：<br><textarea id="ciphertext" placeholder="加密结果或待解密的十六进制密文将显示在这里"></textarea></label>
		</div>

		<div class="btn-group">
			<button id="encryptBtn">加密</button>
			<button id="decryptBtn">解密</button>
			<button id="clearBtn">清空</button>
		</div>
	</div>

	<script>
		function binArrayToHex(binArr) {
			let h = '';
			for (let i = 0; i < binArr.length; i += 4) {
				const n = binArr.slice(i, i + 4);
				while (n.length < 4) n.push(0);
				h += ((n[0] << 3 | n[1] << 2 | n[2] << 1 | n[3]) >>> 0).toString(16);
			}
			return h.toUpperCase();
		}

		function hexToBinArray(hex) {
			const b = [];
			for (let i = 0; i < hex.length; i++) {
				const v = parseInt(hex[i], 16);
				b.push((v >> 3) & 1, (v >> 2) & 1, (v >> 1) & 1, v & 1);
			}
			return b;
		}

		function hexToBytes(hex) {
			hex = hex.replace(/\s+/g, '');
			if (hex.length === 0) return new Uint8Array(0);
			if (hex.length % 2 !== 0) {
				throw new Error('十六进制字符串长度必须为偶数');
			}
			const bytes = new Uint8Array(hex.length / 2);
			for (let i = 0; i < hex.length; i += 2) {
				bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
			}
			return bytes;
		}

		function bytesToHex(bytes) {
			let hex = '';
			for (let i = 0; i < bytes.length; i++) {
				hex += bytes[i].toString(16).padStart(2, '0');
			}
			return hex.toUpperCase();
		}

		function generateRandomBits(numBits) {
			const numBytes = Math.ceil(numBits / 8);
			const randomBytes = crypto.getRandomValues(new Uint8Array(numBytes));
			const bits = new Uint8Array(numBits);

			for (let i = 0; i < numBytes; i++) {
				const byte = randomBytes[i];
				for (let j = 0; j < 8 && i * 8 + j < numBits; j++) {
					bits[i * 8 + j] = (byte >> (7 - j)) & 1;
				}
			}
			return bits;
		}

		function generateRandomBytes(numBytes) {
			return crypto.getRandomValues(new Uint8Array(numBytes));
		}

		const algSel = document.getElementById('algorithm'),
			genKey = document.getElementById('generateKey'),
			genIv = document.getElementById('generateIv'),
			kDisp = document.getElementById('keyDisplay'),
			vDisp = document.getElementById('ivDisplay'),
			pTxt = document.getElementById('plaintext'),
			cTxt = document.getElementById('ciphertext'),
			encBtn = document.getElementById('encryptBtn'),
			decBtn = document.getElementById('decryptBtn'),
			clrBtn = document.getElementById('clearBtn');

		genKey.onclick = () => {
			const algo = algSel.value;
			try {
				if (algo === 'trivium') {
					const keyBits = generateRandomBits(80);
					kDisp.value = binArrayToHex(keyBits);
				} else if (algo === 'grain') {
					const keyBits = generateRandomBits(80);
					kDisp.value = binArrayToHex(keyBits);
				}
			} catch (e) {
				alert('生成随机密钥失败：' + e.message);
			}
		};

		genIv.onclick = () => {
			const algo = algSel.value;
			try {
				if (algo === 'trivium') {
					const ivBits = generateRandomBits(80);
					vDisp.value = binArrayToHex(ivBits);
				} else if (algo === 'grain') {
					const ivBits = generateRandomBits(64);
					vDisp.value = binArrayToHex(ivBits);
				}
			} catch (e) {
				alert('生成随机IV失败：' + e.message);
			}
		};

		encBtn.onclick = () => {
			const algo = algSel.value;
			const kHex = kDisp.value.trim().replace(/\s+/g, '');
			const vHex = vDisp.value.trim().replace(/\s+/g, '');

			if (!kHex || !vHex) {
				alert('请生成或输入密钥和IV');
				return;
			}

			try {
				const key = hexToBinArray(kHex);
				const iv = hexToBinArray(vHex);
				const plaintext = pTxt.value || '';
				const ciphertext = TriviumGrain.encrypt(algo, key, iv, plaintext);
				cTxt.value = bytesToHex(ciphertext);
			} catch (e) {
				alert('加密失败：' + e.message);
				console.error(e);
			}
		};

		decBtn.onclick = () => {
			const cipherHex = cTxt.value.trim().replace(/\s+/g, '');
			if (!cipherHex) {
				alert('请输入十六进制密文');
				return;
			}

			const algo = algSel.value;
			const kHex = kDisp.value.trim().replace(/\s+/g, '');
			const vHex = vDisp.value.trim().replace(/\s+/g, '');

			if (!kHex || !vHex) {
				alert('请生成或输入密钥和IV');
				return;
			}

			try {
				const key = hexToBinArray(kHex);
				const iv = hexToBinArray(vHex);
				const ciphertext = hexToBytes(cipherHex);
				const plaintext = TriviumGrain.decrypt(algo, key, iv, ciphertext);
				pTxt.value = new TextDecoder().decode(plaintext);
			} catch (e) {
				alert('解密失败：' + e.message);
				console.error(e);
			}
		};

		clrBtn.onclick = () => {
			pTxt.value = '';
			cTxt.value = '';
		};

		algSel.onchange = () => {
			kDisp.value = '';
			vDisp.value = '';
		};
	</script>
</body>

</html>